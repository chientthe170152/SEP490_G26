@{
    ViewData["Title"] = "Làm bài thi";
}

@section Styles {
    <!-- MathLive for math rendering -->
    <script defer src="https://unpkg.com/mathlive"></script>
    <link rel="stylesheet" href="~/css/Exam/exam_taking.css" />
}

<!-- Hidden Inputs to pass Razor Variables to Javascript -->
<input type="hidden" id="ExamId" value="@ViewBag.ExamId" />
<input type="hidden" id="PaperId" value="@ViewBag.PaperId" />
<input type="hidden" id="SubmissionId" value="" />

<main class="page-shell py-4" id="examWorkspace" style="display: none;">
    <div class="container-fluid px-3 px-md-4">
      <section class="page-header d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-3 mb-4">
        <div>
          <h1 class="page-title" id="examTitle">Loading...</h1>
          <p class="page-subtitle" id="examSubtitle">Đang chuẩn bị dữ liệu thi...</p>
          <div class="badge bg-info mt-2" style="font-size: 1rem;"><i class="bi bi-file-earmark-text"></i> Mã đề: <span id="paperCodeDisplay">...</span></div>
        </div>
        <div class="soft-card">
          <div class="summary-label">Thời gian còn lại</div>
          <div class="countdown" data-countdown="2400" id="countdownTimer">40:00</div>
        </div>
      </section>

      <div class="row g-3">
        <div class="col-12 col-xl-8" id="questionContainer">
          <!-- Dynamic Question Blocks will be loaded here -->
        </div>

        <div class="col-12 col-xl-4">
          <aside class="panel-card mb-3">
            <h2 class="panel-title">Điều hướng câu hỏi</h2>
            <div class="question-nav mb-2" id="questionNavMap">
              <!-- Dynamic Nav Buttons -->
            </div>
            <p class="form-note mb-0 text-success" id="autoSaveStatus">Hệ thống sẽ tự động lưu bài.</p>
          </aside>

          <div class="toolbar d-flex gap-2 mt-3">
            <button class="btn btn-warning flex-grow-1" data-action="validate-unanswered" onclick="highlightUnanswered()">Kiểm tra câu chưa trả lời</button>
            <button class="btn btn-danger flex-grow-1" onclick="submitExam()">Nộp bài</button>
          </div>
        </div>
      </div>
    </div>
</main>

<div class="text-center mt-5" id="loadingSpinner">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-2">Đang tải đề thi...</p>
</div>

@section Scripts {
    <!-- SignalR for Live Proctoring -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="~/js/StudentExam/exam_taking.js"></script>
}
