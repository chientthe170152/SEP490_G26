<!doctype html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Danh sách lớp học</title>
    <link rel="stylesheet" href="~/vendor/bootstrap-5.3.8/css/bootstrap.min.css">
    <link rel="stylesheet" href="~/css/Course/Course.css">
</head>
<body>
    <main class="page-shell py-4">
        <div class="container-fluid px-3 px-md-4">

            <section class="page-header d-flex justify-content-between align-items-start mb-3">
                <div>
                    <h1 id="pageTitle"></h1>
                    <p class="page-subtitle" id="pageSubtitle"></p>
                </div>

                <div id="actionButtonContainer"></div>
            </section>

            <section class="panel-card mb-3">
                <div class="row g-2">
                    <div class="col-12 col-lg-4">
                        <input type="text"
                               class="form-control"
                               id="courseSearchInput"
                               placeholder="Tìm theo tên lớp hoặc giảng viên">
                    </div>
                    <div class="col-6 col-lg-3">
                        <select class="form-select" id="courseSemesterFilter">
                            <option value="">Tất cả học kỳ</option>
                        </select>
                    </div>
                    <div class="col-6 col-lg-3">
                        <select class="form-select" id="courseSubjectFilter">
                            <option value="">Tất cả môn học</option>
                        </select>
                    </div>
                </div>
            </section>

            <section class="card-grid" id="courseGrid"></section>

        </div>
    </main>

    <!-- JOIN CLASS MODAL -->
    <div class="modal fade" id="joinClassModal" tabindex="-1"
         aria-labelledby="joinClassModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <form class="modal-content" id="joinClassForm">
                <div class="modal-header">
                    <h2 class="modal-title fs-5" id="joinClassModalLabel">
                        Nhập mã mời vào lớp
                    </h2>
                    <button type="button"
                            class="btn-close"
                            data-bs-dismiss="modal"
                            aria-label="Đóng"></button>
                </div>
                <div class="modal-body">
                    <label class="form-label" for="joinClassCodeInput">
                        Mã mời *
                    </label>
                    <input class="form-control"
                           id="joinClassCodeInput"
                           placeholder="Nhập mã mời (ví dụ: INV-SE1711)"
                           autocomplete="off"
                           required>
                    <p class="mt-2 mb-0">
                        Nhập mã mời do giảng viên cung cấp để tham gia lớp học.
                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button"
                            class="btn btn-outline-secondary"
                            data-bs-dismiss="modal">
                        Hủy
                    </button>
                    <button type="submit" class="btn btn-primary">
                        Xác nhận tham gia
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script src="~/vendor/bootstrap-5.3.8/js/bootstrap.bundle.min.js"></script>

    <script>
        const API_BASE = "https://localhost:7167";

        document.addEventListener("DOMContentLoaded", function () {
            initRoleUI();
            loadCourses();
            initJoinForm();
        });

        function getToken() {
            return sessionStorage.getItem("jwtToken")
                || localStorage.getItem("jwtToken")
                || "";
        }

        function getUserRole() {
            return localStorage.getItem("userRole") || "";
        }

        function initRoleUI() {
            const role = getUserRole();
            const title = document.getElementById("pageTitle");
            const subtitle = document.getElementById("pageSubtitle");
            const btnContainer = document.getElementById("actionButtonContainer");

            if (role === "Teacher") {
                title.textContent = "Danh sách lớp giảng dạy";
                subtitle.textContent = "Tìm kiếm và quản lý các lớp học bạn đang giảng dạy.";

                btnContainer.innerHTML = `
                    <a href="/Course/Create" class="btn btn-primary">
                        + Tạo lớp
                    </a>
                `;
            } else {
                title.textContent = "Lớp học của tôi";
                subtitle.textContent = "Tìm kiếm và truy cập các lớp đã tham gia.";

                btnContainer.innerHTML = `
                    <button class="btn btn-primary"
                            type="button"
                            data-bs-toggle="modal"
                            data-bs-target="#joinClassModal">
                        + Tham gia lớp
                    </button>
                `;
            }
        }

        function loadCourses() {
            const token = getToken();
            if (!token) {
                alert("Bạn chưa đăng nhập.");
                return;
            }

            fetch(`${API_BASE}/api/course/my`, {
                headers: {
                    "Authorization": "Bearer " + token
                }
            })
            .then(res => {
                if (!res.ok) throw new Error();
                return res.json();
            })
            .then(data => {
                renderCourses(data);
                initFilters();
            })
            .catch(() => {
                alert("Không thể tải danh sách lớp.");
            });
        }

        function renderCourses(courses) {
            const role = getUserRole();
            const isTeacher = role === "Teacher";
            const grid = document.getElementById("courseGrid");
            grid.innerHTML = "";

            if (!courses || courses.length === 0) {
                grid.innerHTML = "<p>Chưa có lớp học.</p>";
                return;
            }

            const semesters = new Set();
            const subjects = new Set();

            courses.forEach(c => {
                semesters.add(c.semester);
                subjects.add(c.subjectName);

                const article = document.createElement("article");
                article.className = "class-card";
                article.dataset.subject = c.subjectName || "";
                article.dataset.semester = c.semester || "";
                article.dataset.keyword =
                    `${c.className} ${c.teacherName} ${c.subjectName}`.toLowerCase();

                article.innerHTML = `
                    <h2>${c.className}</h2>
                    <p>${c.teacherName}</p>
                    <small>Học kỳ: ${c.semester || ""}</small>
                    <div class="mt-2">
                        Exams: ${c.examCount} • Sĩ số: ${c.studentCount}
                    </div>
                    <div class="mt-2">
                        <a class="btn btn-sm ${isTeacher ? "btn-primary" : "btn-outline-primary"}"
                           href="/Course/ExamListInCourse/${c.classId}">
                           Vào khóa học
                        </a>
                        ${!isTeacher ? `
                            <button class="btn btn-sm btn-danger"
                                    onclick="leaveCourse(${c.classId})">
                                Rời khóa học
                            </button>
                        ` : ""}
                    </div>
                `;

                grid.appendChild(article);
            });

            populateSelect("courseSemesterFilter", semesters);
            populateSelect("courseSubjectFilter", subjects);
        }

        function populateSelect(id, values) {
            const select = document.getElementById(id);
            select.innerHTML = '<option value="">Tất cả</option>';
            values.forEach(v => {
                if (!v) return;
                const option = document.createElement("option");
                option.value = v;
                option.textContent = v;
                select.appendChild(option);
            });
        }

        function initFilters() {
            const search = document.getElementById("courseSearchInput");
            const semester = document.getElementById("courseSemesterFilter");
            const subject = document.getElementById("courseSubjectFilter");

            [search, semester, subject].forEach(el => {
                el.addEventListener("input", applyFilters);
                el.addEventListener("change", applyFilters);
            });
        }

        function applyFilters() {
            const keyword = document.getElementById("courseSearchInput").value.toLowerCase();
            const semester = document.getElementById("courseSemesterFilter").value.toLowerCase();
            const subject = document.getElementById("courseSubjectFilter").value.toLowerCase();

            document.querySelectorAll(".class-card").forEach(card => {
                const matchKeyword = !keyword || card.dataset.keyword.includes(keyword);
                const matchSemester = !semester || card.dataset.semester.toLowerCase() === semester;
                const matchSubject = !subject || card.dataset.subject.toLowerCase() === subject;

                card.classList.toggle("d-none",
                    !(matchKeyword && matchSemester && matchSubject));
            });
        }

        function leaveCourse(classId) {
            if (!confirm("Bạn chắc chắn muốn rời khóa học này?")) return;

            const token = getToken();

            fetch(`${API_BASE}/api/course/${classId}/leave`, {
                method: "POST",
                headers: {
                    "Authorization": "Bearer " + token
                }
            })
            .then(res => {
                if (!res.ok) throw new Error();
                alert("Đã rời khóa học.");
                loadCourses();
            })
            .catch(() => {
                alert("Không thể rời khóa học.");
            });
        }

        function initJoinForm() {
            const joinForm = document.getElementById("joinClassForm");

            joinForm.addEventListener("submit", function (e) {
                e.preventDefault();

                const code = document
                    .getElementById("joinClassCodeInput")
                    .value
                    .trim();

                if (!code) return;

                const token = getToken();

                fetch(`${API_BASE}/api/course/join`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": "Bearer " + token
                    },
                    body: JSON.stringify({ invitationCode: code })
                })
                .then(res => {
                    if (!res.ok) throw new Error();
                    alert("Tham gia lớp thành công!");

                    const modalEl = document.getElementById("joinClassModal");
                    const modal = bootstrap.Modal.getInstance(modalEl);
                    modal.hide();

                    joinForm.reset();
                    loadCourses();
                })
                .catch(() => {
                    alert("Mã mời không hợp lệ hoặc đã xảy ra lỗi.");
                });
            });
        }
    </script>
</body>
</html>
