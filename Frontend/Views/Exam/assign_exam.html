<!doctype html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Giao đề thi</title>
  <link rel="stylesheet" href="../vendor/bootstrap-5.3.8/css/bootstrap.min.css">
  <link rel="stylesheet" href="../css/exam_preview.css">
</head>
<body>
  <main class="page-shell py-4">
    <div class="container-fluid px-3 px-md-4">
      <section class="page-header d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-3">
        <div>
          <h1 class="page-title">Giao đề thi</h1>
          <p class="page-subtitle">Thiết lập cấu hình đề thi và gán cho lớp học trên cùng một màn hình.</p>
        </div>
        <div class="page-actions">
          <button class="btn btn-outline-secondary" type="button" id="closeConfigTop">Đóng</button>
          <button class="btn btn-primary" type="button" id="saveConfigTop">Lưu cấu hình</button>
        </div>
      </section>

      <section class="panel-card mb-3">
        <p class="meta-line mb-2">Tóm tắt: 40 phút • 1 lần làm • 21/02/2026 07:30 - 09:30</p>

        <h2 class="section-title">Cấu hình cơ bản</h2>
        <div class="row g-2">
          <div class="col-12 col-md-8">
            <label class="form-label">Tiêu đề đề thi *</label>
            <input class="form-control" value="MAE - SP26 - SE1711">
          </div>
          <div class="col-12">
            <label class="form-label">Mô tả</label>
            <textarea class="form-control" rows="3">No materials allowed. System auto-submits at timeout.</textarea>
          </div>
          <div class="col-6 col-md-2">
            <label class="form-label">Số lần làm</label>
            <input type="number" class="form-control" value="1">
          </div>
        </div>

        <hr class="section-divider">

        <h2 class="section-title">Lịch thi</h2>
        <div class="row g-2">
          <div class="col-12 col-md-3">
            <label class="form-label">Thời điểm học sinh thấy đề</label>
            <input class="form-control" type="datetime-local">
          </div>
          <div class="col-12 col-md-3">
            <label class="form-label">Thời điểm mở</label>
            <input class="form-control" type="datetime-local">
          </div>
          <div class="col-12 col-md-3">
            <label class="form-label">Thời điểm đóng</label>
            <input class="form-control" type="datetime-local">
          </div>
          <div class="col-12 col-md-3">
            <label class="form-label">Thời lượng (phút)</label>
            <input class="form-control" type="number" value="40">
          </div>
        </div>

        <hr class="section-divider">

        <h2 class="section-title">Quy tắc làm bài</h2>
        <div class="row g-2">
          <div class="col-12">
            <div class="form-check"><input class="form-check-input" type="checkbox" id="rule1" checked><label class="form-check-label" for="rule1">Trộn câu hỏi</label></div>
            <div class="form-check"><input class="form-check-input" type="checkbox" id="rule3"><label class="form-check-label" for="rule3">Cho phép nộp trễ</label></div>
          </div>
        </div>

        <hr class="section-divider">

        <h2 class="section-title">Bảo mật và công bố</h2>
        <div class="row g-2">
          <div class="col-12 d-flex flex-column justify-content-center gap-2">
            <div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="showScore"><label class="form-check-label" for="showScore">Hiển thị điểm ngay khi nộp</label></div>
            <div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="publicExamToggle"><label class="form-check-label" for="publicExamToggle">Tạo đề public</label></div>
            <p class="form-note mb-0">Khi bật đề public, hệ thống sẽ ẩn phần chọn lớp học.</p>
            <div id="publicSubjectSection" class="d-none">
              <label class="form-label mt-1">Môn học (đề public)</label>
              <select class="form-select" id="publicSubjectFilter">
                <option value="">Chọn môn học</option>
                <option value="MAE">MAE</option>
                <option value="MAD">MAD</option>
                <option value="MAS">MAS</option>
              </select>
              <p class="form-note mb-0 mt-1">Danh sách ma trận đề và câu hỏi thủ công sẽ lọc theo môn đã chọn.</p>
            </div>
          </div>
        </div>

        <div id="classSelectionBlock">
          <hr class="section-divider">
          <div id="classSelectionSection">
          <div class="d-flex justify-content-between align-items-center gap-2 mb-2">
            <h2 class="section-title mb-0">Chọn lớp học</h2>
            <span class="form-note" id="selectedClassCount">Đã chọn: SE1711</span>
          </div>

          <div class="row g-2 mb-2">
            <div class="col-12 col-md-6">
              <input class="form-control" id="classSearchInput" placeholder="Tìm theo mã lớp (ví dụ: SE1711)">
            </div>
            <div class="col-6 col-md-3">
              <select class="form-select" id="classSubjectFilter">
                <option value="">Tất cả môn</option>
                <option value="MAE">MAE</option>
                <option value="MAD">MAD</option>
                <option value="MAS">MAS</option>
              </select>
            </div>
            <div class="col-6 col-md-3">
              <select class="form-select" id="classSemesterFilter">
                <option value="">Tất cả học kỳ</option>
                <option value="SP26">SP26</option>
                <option value="SU26">SU26</option>
                <option value="FA25">FA25</option>
              </select>
            </div>
          </div>
          <p class="form-note mb-2">Chỉ được chọn một lớp học cho mỗi lần giao đề.</p>

          <div class="border rounded bg-white overflow-auto" style="max-height: 320px;">
            <table class="table table-soft table-sm align-middle mb-0" id="classSelectionTable">
              <thead>
                <tr>
                  <th style="width: 56px;">Chọn</th>
                  <th>Mã lớp</th>
                  <th>Môn học</th>
                  <th>Học kỳ</th>
                  <th>Sĩ số</th>
                </tr>
              </thead>
              <tbody>
                <tr data-class-code="SE1711" data-subject="MAE" data-semester="SP26">
                  <td><input class="form-check-input class-item" type="radio" name="selectedClass" checked></td>
                  <td>SE1711</td>
                  <td>MAE</td>
                  <td>SP26</td>
                  <td>52</td>
                </tr>
                <tr data-class-code="SE1730" data-subject="MAE" data-semester="SP26">
                  <td><input class="form-check-input class-item" type="radio" name="selectedClass"></td>
                  <td>SE1730</td>
                  <td>MAE</td>
                  <td>SP26</td>
                  <td>49</td>
                </tr>
                <tr data-class-code="SE1708" data-subject="MAD" data-semester="FA25">
                  <td><input class="form-check-input class-item" type="radio" name="selectedClass"></td>
                  <td>SE1708</td>
                  <td>MAD</td>
                  <td>FA25</td>
                  <td>46</td>
                </tr>
                <tr data-class-code="SE1715" data-subject="MAD" data-semester="SU26">
                  <td><input class="form-check-input class-item" type="radio" name="selectedClass"></td>
                  <td>SE1715</td>
                  <td>MAD</td>
                  <td>SU26</td>
                  <td>44</td>
                </tr>
                <tr data-class-code="SE1722" data-subject="MAS" data-semester="SP26">
                  <td><input class="form-check-input class-item" type="radio" name="selectedClass"></td>
                  <td>SE1722</td>
                  <td>MAS</td>
                  <td>SP26</td>
                  <td>48</td>
                </tr>
                <tr data-class-code="SE1741" data-subject="MAS" data-semester="FA25">
                  <td><input class="form-check-input class-item" type="radio" name="selectedClass"></td>
                  <td>SE1741</td>
                  <td>MAS</td>
                  <td>FA25</td>
                  <td>47</td>
                </tr>
                <tr data-class-code="SE1750" data-subject="MAE" data-semester="SU26">
                  <td><input class="form-check-input class-item" type="radio" name="selectedClass"></td>
                  <td>SE1750</td>
                  <td>MAE</td>
                  <td>SU26</td>
                  <td>51</td>
                </tr>
                <tr data-class-code="SE1762" data-subject="MAD" data-semester="SP26">
                  <td><input class="form-check-input class-item" type="radio" name="selectedClass"></td>
                  <td>SE1762</td>
                  <td>MAD</td>
                  <td>SP26</td>
                  <td>45</td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-2 mt-2">
            <p class="form-note mb-0" id="classPaginationSummary">Hiển thị 1-5 trên 8 lớp</p>
            <nav aria-label="Phân trang danh sách lớp học">
              <ul class="pagination mb-0">
                <li class="page-item">
                  <button class="page-link" type="button" id="classPaginationPrev">Trước</button>
                </li>
                <li class="page-item active" data-page-item="1">
                  <button class="page-link" type="button" data-class-page="1">1</button>
                </li>
                <li class="page-item" data-page-item="2">
                  <button class="page-link" type="button" data-class-page="2">2</button>
                </li>
                <li class="page-item">
                  <button class="page-link" type="button" id="classPaginationNext">Sau</button>
                </li>
              </ul>
            </nav>
          </div>
          </div>
          <hr class="section-divider">
        </div>

        <h2 class="section-title">Kiểu tạo đề</h2>
        <div class="row g-2 mb-3">
          <div class="col-12">
            <div class="d-flex flex-column flex-md-row gap-3">
              <div class="form-check">
                <input class="form-check-input" type="radio" name="examGenerationMode" id="examGenerationBlueprint" checked>
                <label class="form-check-label" for="examGenerationBlueprint">Tạo theo ma trận đề</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="examGenerationMode" id="examGenerationManual">
                <label class="form-check-label" for="examGenerationManual">Chọn câu hỏi thủ công</label>
              </div>
            </div>
          </div>
        </div>

        <div id="blueprintModeSection">
          <h2 class="section-title">Chọn ma trận đề</h2>
          <div class="row g-3" id="blueprintSelectionSection">
          <div class="col-12 col-xl-5">
            <div class="soft-card h-100">
              <div class="d-flex justify-content-between align-items-center gap-2 mb-2">
                <h3 class="section-title mb-0">Danh sách ma trận đề</h3>
                <span class="form-note" id="selectedBlueprintName">Đang chọn: pt1</span>
              </div>

              <div class="row g-2 mb-2">
                <div class="col-12">
                  <input class="form-control" id="blueprintSearchInput" placeholder="Tìm theo tên ma trận đề (ví dụ: pt1)">
                </div>
                <div class="col-12">
                  <select class="form-select" id="blueprintSubjectFilter">
                    <option value="">Tất cả môn</option>
                    <option value="MAE">MAE</option>
                    <option value="MAD">MAD</option>
                    <option value="MAS">MAS</option>
                  </select>
                </div>
              </div>

              <div class="border rounded bg-white overflow-auto" style="max-height: 320px;">
                <table class="table table-soft table-sm align-middle mb-0" id="blueprintListTable">
                  <thead>
                    <tr>
                      <th style="width: 56px;">Chọn</th>
                      <th>Tên ma trận đề</th>
                      <th>Môn học</th>
                      <th>Ngày cập nhật</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr class="interactive-row" data-blueprint-id="pt1" data-blueprint-name="pt1" data-subject="MAE" data-updated="12/02/2026">
                      <td><input class="form-check-input blueprint-item" type="radio" name="selectedBlueprint" checked></td>
                      <td>pt1</td>
                      <td>MAE</td>
                      <td>12/02/2026</td>
                    </tr>
                    <tr class="interactive-row" data-blueprint-id="pt2" data-blueprint-name="pt2" data-subject="MAE" data-updated="14/02/2026">
                      <td><input class="form-check-input blueprint-item" type="radio" name="selectedBlueprint"></td>
                      <td>pt2</td>
                      <td>MAE</td>
                      <td>14/02/2026</td>
                    </tr>
                    <tr class="interactive-row" data-blueprint-id="final_exam" data-blueprint-name="final exam" data-subject="MAD" data-updated="10/02/2026">
                      <td><input class="form-check-input blueprint-item" type="radio" name="selectedBlueprint"></td>
                      <td>final exam</td>
                      <td>MAD</td>
                      <td>10/02/2026</td>
                    </tr>
                    <tr class="interactive-row" data-blueprint-id="retake" data-blueprint-name="retake" data-subject="MAS" data-updated="08/02/2026">
                      <td><input class="form-check-input blueprint-item" type="radio" name="selectedBlueprint"></td>
                      <td>retake</td>
                      <td>MAS</td>
                      <td>08/02/2026</td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-2 mt-2">
                <p class="form-note mb-0" id="blueprintFilterSummary">Hiển thị 1-2 trên 4 ma trận đề.</p>
                <nav aria-label="Phân trang danh sách ma trận đề">
                  <ul class="pagination mb-0">
                    <li class="page-item">
                      <button class="page-link" type="button" id="blueprintPaginationPrev">Trước</button>
                    </li>
                    <li class="page-item active" data-blueprint-page-item="1">
                      <button class="page-link" type="button" data-blueprint-page="1">1</button>
                    </li>
                    <li class="page-item" data-blueprint-page-item="2">
                      <button class="page-link" type="button" data-blueprint-page="2">2</button>
                    </li>
                    <li class="page-item">
                      <button class="page-link" type="button" id="blueprintPaginationNext">Sau</button>
                    </li>
                  </ul>
                </nav>
              </div>
            </div>
          </div>

          <div class="col-12 col-xl-7">
            <div class="soft-card h-100">
              <div class="d-flex justify-content-between align-items-center gap-2 mb-2">
                <h3 class="section-title mb-0">Chi tiết ma trận đề</h3>
                <span class="tag-pill tag-neutral" id="blueprintInfoSubject">MAE</span>
              </div>

              <div class="row g-2 mb-2">
                <div class="col-12 col-md-6">
                  <div class="summary-card py-2">
                    <p class="summary-label mb-1">Tên ma trận đề</p>
                    <p class="mb-0 fw-semibold" id="blueprintInfoName">pt1</p>
                  </div>
                </div>
                <div class="col-12 col-md-6">
                  <div class="summary-card py-2">
                    <p class="summary-label mb-1">Ngày cập nhật</p>
                    <p class="mb-0 fw-semibold" id="blueprintInfoUpdated">12/02/2026</p>
                  </div>
                </div>
                <div class="col-12">
                  <div class="summary-card py-2">
                    <p class="summary-label mb-1">Số câu hỏi của mã đề</p>
                    <p class="mb-0 fw-semibold" id="blueprintInfoQuestionCount">18 câu</p>
                  </div>
                </div>
              </div>
              <p class="form-note mb-2">Số câu hỏi của mã đề có thể nhỏ hơn tổng số câu trong ma trận đề.</p>

              <div class="table-responsive border rounded bg-white">
                <table class="table table-soft table-sm align-middle mb-0" id="blueprintMatrixTable">
                  <thead>
                    <tr>
                      <th>Chương</th>
                      <th>Mức độ</th>
                      <th>Số câu</th>
                    </tr>
                  </thead>
                  <tbody id="blueprintMatrixBody">
                    <tr>
                      <td>Chương 1: Limits</td>
                      <td>Nhận biết</td>
                      <td>6</td>
                    </tr>
                    <tr>
                      <td>Chương 2: Derivatives</td>
                      <td>Thông hiểu</td>
                      <td>6</td>
                    </tr>
                    <tr>
                      <td>Chương 3: Integrals</td>
                      <td>Vận dụng</td>
                      <td>5</td>
                    </tr>
                    <tr>
                      <td>Chương 4: Applications</td>
                      <td>Vận dụng cao</td>
                      <td>3</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          </div>
        </div>

        <hr class="section-divider" id="examGenerationModeDivider">

        <div id="manualModeSection" hidden>
          <h2 class="section-title">Thêm câu hỏi thủ công</h2>
          <div class="soft-card">
          <div class="row g-2 mb-2">
            <div class="col-12 col-md-3">
              <label class="form-label">Môn học</label>
              <select class="form-select" id="manualQuestionSubjectFilter">
                <option value="">Tất cả môn</option>
                <option value="MAE">MAE</option>
                <option value="MAD">MAD</option>
                <option value="MAS">MAS</option>
              </select>
            </div>
            <div class="col-12 col-md-3">
              <label class="form-label">Chương</label>
              <select class="form-select" id="manualQuestionChapterFilter">
                <option value="">Tất cả chương</option>
              </select>
            </div>
            <div class="col-12 col-md-3">
              <label class="form-label">Mức độ</label>
              <select class="form-select" id="manualQuestionLevelFilter">
                <option value="">Tất cả mức độ</option>
                <option value="Nhận biết">Nhận biết</option>
                <option value="Thông hiểu">Thông hiểu</option>
                <option value="Vận dụng">Vận dụng</option>
                <option value="Vận dụng cao">Vận dụng cao</option>
              </select>
            </div>
            <div class="col-12 col-md-3">
              <label class="form-label">Tìm câu hỏi</label>
              <input class="form-control" id="manualQuestionSearchInput" placeholder="Nhập mã câu hoặc nội dung">
            </div>
          </div>
          <div class="d-flex justify-content-between align-items-center gap-2 mb-2">
            <p class="form-note mb-0" id="manualQuestionSummary">Đã chọn 0 câu hỏi thủ công.</p>
            <button class="btn btn-sm btn-outline-secondary" type="button" id="manualQuestionClearButton">Bỏ chọn tất cả</button>
          </div>
          <div class="table-responsive border rounded bg-white">
            <table class="table table-soft table-sm align-middle mb-0" id="manualQuestionTable">
              <thead>
                <tr>
                  <th style="width: 56px;">Chọn</th>
                  <th>Mã câu hỏi</th>
                  <th>Môn học</th>
                  <th>Chương</th>
                  <th>Mức độ</th>
                  <th>Nội dung</th>
                </tr>
              </thead>
              <tbody id="manualQuestionTableBody"></tbody>
            </table>
          </div>
            <p class="form-note mt-2 mb-0">Giáo viên có thể lọc theo môn/chương rồi chọn thủ công từng câu hỏi để thêm vào đề.</p>
          </div>
        </div>

        <div class="d-flex justify-content-end gap-2 mt-3">
          <button class="btn btn-outline-secondary" type="button" id="closeConfigBottom">Đóng</button>
          <button class="btn btn-primary" type="button" id="saveConfigBottom">Lưu cấu hình</button>
        </div>
      </section>
    </div>
  </main>
  <script src="../vendor/bootstrap-5.3.8/js/bootstrap.bundle.min.js"></script>
  <script src="../js/exam_preview.js"></script>
  <script>
    (() => {
      const publicToggle = document.getElementById('publicExamToggle');
      const classSelectionBlock = document.getElementById('classSelectionBlock');
      const classSection = document.getElementById('classSelectionSection');
      const classSearchInput = document.getElementById('classSearchInput');
      const classSubjectFilter = document.getElementById('classSubjectFilter');
      const classSemesterFilter = document.getElementById('classSemesterFilter');
      const classTable = document.getElementById('classSelectionTable');
      const selectedCount = document.getElementById('selectedClassCount');
      const classPaginationPrev = document.getElementById('classPaginationPrev');
      const classPaginationNext = document.getElementById('classPaginationNext');
      const classPageButtons = Array.from(document.querySelectorAll('[data-class-page]'));
      const classPageItems = Array.from(document.querySelectorAll('[data-page-item]'));
      const classPaginationSummary = document.getElementById('classPaginationSummary');
      const blueprintSearchInput = document.getElementById('blueprintSearchInput');
      const blueprintSubjectFilter = document.getElementById('blueprintSubjectFilter');
      const blueprintListTable = document.getElementById('blueprintListTable');
      const selectedBlueprintName = document.getElementById('selectedBlueprintName');
      const blueprintFilterSummary = document.getElementById('blueprintFilterSummary');
      const blueprintInfoName = document.getElementById('blueprintInfoName');
      const blueprintInfoUpdated = document.getElementById('blueprintInfoUpdated');
      const blueprintInfoSubject = document.getElementById('blueprintInfoSubject');
      const blueprintInfoQuestionCount = document.getElementById('blueprintInfoQuestionCount');
      const blueprintMatrixBody = document.getElementById('blueprintMatrixBody');
      const blueprintPaginationPrev = document.getElementById('blueprintPaginationPrev');
      const blueprintPaginationNext = document.getElementById('blueprintPaginationNext');
      const blueprintPageButtons = Array.from(document.querySelectorAll('[data-blueprint-page]'));
      const blueprintPageItems = Array.from(document.querySelectorAll('[data-blueprint-page-item]'));
      const examGenerationBlueprint = document.getElementById('examGenerationBlueprint');
      const examGenerationManual = document.getElementById('examGenerationManual');
      const blueprintModeSection = document.getElementById('blueprintModeSection');
      const manualModeSection = document.getElementById('manualModeSection');
      const examGenerationModeDivider = document.getElementById('examGenerationModeDivider');
      const manualQuestionSubjectFilter = document.getElementById('manualQuestionSubjectFilter');
      const manualQuestionChapterFilter = document.getElementById('manualQuestionChapterFilter');
      const manualQuestionSearchInput = document.getElementById('manualQuestionSearchInput');
      const manualQuestionTable = document.getElementById('manualQuestionTable');
      const manualQuestionTableBody = document.getElementById('manualQuestionTableBody');
      const manualQuestionSummary = document.getElementById('manualQuestionSummary');
      const manualQuestionClearButton = document.getElementById('manualQuestionClearButton');
      const pageSize = 5;
      const blueprintPageSize = 2;
      let currentPage = 1;
      let blueprintCurrentPage = 1;

      if (!publicToggle || !classSection || !classTable) {
        return;
      }

      const classSelectors = () => Array.from(classTable.querySelectorAll('.class-item'));
      const rows = () => Array.from(classTable.querySelectorAll('tbody tr'));
      const blueprintSelectors = () => blueprintListTable ? Array.from(blueprintListTable.querySelectorAll('.blueprint-item')) : [];
      const blueprintRows = () => blueprintListTable ? Array.from(blueprintListTable.querySelectorAll('tbody tr')) : [];
      const manualSelectedQuestionIds = new Set();

      const normalizeText = (value = '') => value
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .trim();

      const manualQuestionData = [
        { id: 'MAE-Q001', subject: 'MAE', chapter: 'Giới hạn', content: 'Tính lim x->0 (sinx/x).', aliases: ['limits', 'gioi han'] },
        { id: 'MAE-Q002', subject: 'MAE', chapter: 'Giới hạn', content: 'Tính lim x->∞ ((2x+1)/(x-3)).', aliases: ['limits', 'gioi han'] },
        { id: 'MAE-Q003', subject: 'MAE', chapter: 'Giới hạn', content: 'Tìm giới hạn một phía của hàm số.', aliases: ['limits', 'gioi han'] },
        { id: 'MAE-Q004', subject: 'MAE', chapter: 'Giới hạn', content: 'Áp dụng quy tắc L Hospital để tính giới hạn.', aliases: ['limits', 'gioi han'] },
        { id: 'MAE-Q010', subject: 'MAE', chapter: 'Đạo hàm', content: 'Tính đạo hàm bậc nhất của hàm đa thức.', aliases: ['derivatives', 'dao ham'] },
        { id: 'MAE-Q011', subject: 'MAE', chapter: 'Đạo hàm', content: 'Viết phương trình tiếp tuyến tại một điểm.', aliases: ['derivatives', 'dao ham'] },
        { id: 'MAE-Q020', subject: 'MAE', chapter: 'Tích phân', content: 'Tính tích phân xác định bằng đổi biến.', aliases: ['integrals', 'tich phan'] },
        { id: 'MAD-Q003', subject: 'MAD', chapter: 'Data Types', content: 'Phân biệt value type và reference type.', aliases: ['data types'] },
        { id: 'MAD-Q015', subject: 'MAD', chapter: 'OOP', content: 'Phân tích ví dụ về kế thừa và đa hình.', aliases: ['oop'] },
        { id: 'MAS-Q002', subject: 'MAS', chapter: 'Probability Basics', content: 'Tính xác suất xuất hiện biến cố độc lập.', aliases: ['probability'] },
        { id: 'MAS-Q020', subject: 'MAS', chapter: 'Hypothesis Testing', content: 'Thực hiện kiểm định z-test cho mẫu lớn.', aliases: ['hypothesis testing'] }
      ];

      const blueprintData = {
        pt1: {
          name: 'pt1',
          subject: 'MAE',
          updated: '12/02/2026',
          questionCount: 18,
          matrix: [
            { chapter: 'Chương 1: Limits', level: 'Nhận biết', count: 6 },
            { chapter: 'Chương 2: Derivatives', level: 'Thông hiểu', count: 6 },
            { chapter: 'Chương 3: Integrals', level: 'Vận dụng', count: 5 },
            { chapter: 'Chương 4: Applications', level: 'Vận dụng cao', count: 3 }
          ]
        },
        pt2: {
          name: 'pt2',
          subject: 'MAE',
          updated: '14/02/2026',
          questionCount: 16,
          matrix: [
            { chapter: 'Chương 1: Limits', level: 'Nhận biết', count: 5 },
            { chapter: 'Chương 2: Derivatives', level: 'Thông hiểu', count: 5 },
            { chapter: 'Chương 3: Integrals', level: 'Vận dụng', count: 4 },
            { chapter: 'Chương 4: Applications', level: 'Vận dụng cao', count: 2 }
          ]
        },
        final_exam: {
          name: 'final exam',
          subject: 'MAD',
          updated: '10/02/2026',
          questionCount: 24,
          matrix: [
            { chapter: 'Chương 1: Data Types', level: 'Nhận biết', count: 8 },
            { chapter: 'Chương 2: OOP', level: 'Thông hiểu', count: 7 },
            { chapter: 'Chương 3: Exception Handling', level: 'Vận dụng', count: 6 },
            { chapter: 'Chương 4: Project Scenario', level: 'Vận dụng cao', count: 3 }
          ]
        },
        retake: {
          name: 'retake',
          subject: 'MAS',
          updated: '08/02/2026',
          questionCount: 14,
          matrix: [
            { chapter: 'Chương 1: Probability Basics', level: 'Nhận biết', count: 4 },
            { chapter: 'Chương 2: Distributions', level: 'Thông hiểu', count: 4 },
            { chapter: 'Chương 3: Hypothesis Testing', level: 'Vận dụng', count: 4 },
            { chapter: 'Chương 4: Statistical Cases', level: 'Vận dụng cao', count: 2 }
          ]
        }
      };

      const updateSelectedCount = () => {
        const selectedInput = classSelectors().find((item) => item.checked);
        const selectedRow = selectedInput ? selectedInput.closest('tr') : null;
        const selectedCode = selectedRow ? (selectedRow.getAttribute('data-class-code') || '') : '';
        selectedCount.textContent = selectedCode ? `Đã chọn: ${selectedCode}` : 'Chưa chọn lớp học';
      };

      const applyPublicMode = () => {
        const shouldHideClassSelection = Boolean(publicToggle.checked);
        if (classSelectionBlock) {
          classSelectionBlock.classList.toggle('d-none', shouldHideClassSelection);
          classSelectionBlock.style.display = shouldHideClassSelection ? 'none' : '';
          classSelectionBlock.setAttribute('aria-hidden', shouldHideClassSelection ? 'true' : 'false');
          return;
        }
        classSection.classList.toggle('d-none', shouldHideClassSelection);
        classSection.style.display = shouldHideClassSelection ? 'none' : '';
        classSection.setAttribute('aria-hidden', shouldHideClassSelection ? 'true' : 'false');
      };

      const applyExamGenerationMode = () => {
        const useManualMode = Boolean(examGenerationManual && examGenerationManual.checked);
        if (blueprintModeSection) {
          blueprintModeSection.classList.toggle('d-none', useManualMode);
          blueprintModeSection.hidden = useManualMode;
          blueprintModeSection.style.display = useManualMode ? 'none' : '';
          blueprintModeSection.setAttribute('aria-hidden', useManualMode ? 'true' : 'false');
        }
        if (manualModeSection) {
          manualModeSection.classList.toggle('d-none', !useManualMode);
          manualModeSection.hidden = !useManualMode;
          manualModeSection.style.display = !useManualMode ? 'none' : '';
          manualModeSection.setAttribute('aria-hidden', !useManualMode ? 'true' : 'false');
        }
        if (examGenerationModeDivider) {
          examGenerationModeDivider.classList.add('d-none');
        }
      };

      const getFilteredRows = () => {
        const keyword = (classSearchInput.value || '').trim().toLowerCase();
        const selectedSubject = (classSubjectFilter ? classSubjectFilter.value : '').trim().toLowerCase();
        const selectedSemester = (classSemesterFilter ? classSemesterFilter.value : '').trim().toLowerCase();
        return rows().filter((row) => {
          const classCode = (row.getAttribute('data-class-code') || '').toLowerCase();
          const classSubject = (row.getAttribute('data-subject') || '').toLowerCase();
          const classSemester = (row.getAttribute('data-semester') || '').toLowerCase();
          const matchCode = keyword.length === 0 || classCode.includes(keyword);
          const matchSubject = selectedSubject.length === 0 || classSubject === selectedSubject;
          const matchSemester = selectedSemester.length === 0 || classSemester === selectedSemester;
          return matchCode && matchSubject && matchSemester;
        });
      };

      const renderClassTable = (resetPage = false) => {
        const filteredRows = getFilteredRows();
        const totalRows = filteredRows.length;
        const totalPages = Math.max(1, Math.ceil(totalRows / pageSize));

        if (resetPage) {
          currentPage = 1;
        }
        currentPage = Math.min(currentPage, totalPages);

        const startIndex = totalRows === 0 ? 0 : (currentPage - 1) * pageSize;
        const endIndex = Math.min(startIndex + pageSize, totalRows);
        const visibleRows = filteredRows.slice(startIndex, endIndex);

        rows().forEach((row) => row.classList.add('d-none'));
        visibleRows.forEach((row) => row.classList.remove('d-none'));

        if (classPaginationSummary) {
          classPaginationSummary.textContent = totalRows === 0
            ? 'Không có lớp học phù hợp bộ lọc.'
            : `Hiển thị ${startIndex + 1}-${endIndex} trên ${totalRows} lớp`;
        }

        classPageButtons.forEach((button, idx) => {
          const pageNumber = idx + 1;
          const pageItem = classPageItems[idx];
          const isEnabled = totalRows > 0 && pageNumber <= totalPages;
          const isActive = isEnabled && currentPage === pageNumber;

          button.disabled = !isEnabled;

          if (pageItem) {
            pageItem.classList.toggle('active', isActive);
            pageItem.classList.toggle('disabled', !isEnabled);
          }
        });

        if (classPaginationPrev) {
          classPaginationPrev.disabled = totalRows === 0 || currentPage <= 1;
        }

        if (classPaginationNext) {
          classPaginationNext.disabled = totalRows === 0 || currentPage >= totalPages;
        }
      };

      const renderBlueprintMatrix = (matrixRows) => {
        if (!blueprintMatrixBody) {
          return;
        }

        if (!matrixRows || matrixRows.length === 0) {
          blueprintMatrixBody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">Không có dữ liệu ma trận đề.</td></tr>';
          return;
        }

        blueprintMatrixBody.innerHTML = matrixRows.map((item) => `
          <tr>
            <td>${item.chapter}</td>
            <td>${item.level}</td>
            <td>${item.count}</td>
          </tr>
        `).join('');
      };

      const updateManualQuestionSummary = () => {
        if (!manualQuestionSummary) {
          return;
        }
        const selectedTotal = manualSelectedQuestionIds.size;
        manualQuestionSummary.textContent = `Đã chọn ${selectedTotal} câu hỏi thủ công.`;
      };

      const getFilteredManualQuestions = () => {
        const selectedSubject = manualQuestionSubjectFilter ? (manualQuestionSubjectFilter.value || '').trim() : '';
        const selectedChapter = manualQuestionChapterFilter ? (manualQuestionChapterFilter.value || '').trim() : '';
        const keyword = manualQuestionSearchInput ? (manualQuestionSearchInput.value || '').trim() : '';
        const normalizedSubject = normalizeText(selectedSubject);
        const normalizedChapter = normalizeText(selectedChapter);
        const normalizedKeyword = normalizeText(keyword);

        return manualQuestionData.filter((item) => {
          const matchSubject = normalizedSubject.length === 0 || normalizeText(item.subject) === normalizedSubject;
          const chapterIndex = `${item.chapter} ${(item.aliases || []).join(' ')}`;
          const matchChapter = normalizedChapter.length === 0 || normalizeText(chapterIndex).includes(normalizedChapter);
          const searchIndex = `${item.id} ${item.subject} ${item.chapter} ${item.content} ${(item.aliases || []).join(' ')}`;
          const matchKeyword = normalizedKeyword.length === 0 || normalizeText(searchIndex).includes(normalizedKeyword);
          return matchSubject && matchChapter && matchKeyword;
        });
      };

      const syncManualQuestionChapterOptions = () => {
        if (!manualQuestionChapterFilter || !manualQuestionSubjectFilter) {
          return;
        }
        const selectedSubject = normalizeText(manualQuestionSubjectFilter.value || '');
        const chapterSet = new Set();

        manualQuestionData.forEach((item) => {
          const matchSubject = selectedSubject.length === 0 || normalizeText(item.subject) === selectedSubject;
          if (matchSubject) {
            chapterSet.add(item.chapter);
          }
        });

        const currentValue = manualQuestionChapterFilter.value;
        manualQuestionChapterFilter.innerHTML = '<option value="">Tất cả chương</option>';
        Array.from(chapterSet).sort((a, b) => a.localeCompare(b, 'vi')).forEach((chapter) => {
          const option = document.createElement('option');
          option.value = chapter;
          option.textContent = chapter;
          manualQuestionChapterFilter.appendChild(option);
        });

        if (currentValue && chapterSet.has(currentValue)) {
          manualQuestionChapterFilter.value = currentValue;
        }
      };

      const renderManualQuestionTable = () => {
        if (!manualQuestionTableBody) {
          return;
        }
        const filteredQuestions = getFilteredManualQuestions();

        if (filteredQuestions.length === 0) {
          manualQuestionTableBody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Không có câu hỏi phù hợp bộ lọc.</td></tr>';
          updateManualQuestionSummary();
          return;
        }

        manualQuestionTableBody.innerHTML = filteredQuestions.map((item) => `
          <tr>
            <td><input class="form-check-input manual-question-item" type="checkbox" data-question-id="${item.id}" ${manualSelectedQuestionIds.has(item.id) ? 'checked' : ''}></td>
            <td>${item.id}</td>
            <td>${item.subject}</td>
            <td>${item.chapter}</td>
            <td>${item.content}</td>
          </tr>
        `).join('');

        manualQuestionTableBody.querySelectorAll('.manual-question-item').forEach((checkbox) => {
          checkbox.addEventListener('change', (event) => {
            const questionId = event.target.getAttribute('data-question-id');
            if (!questionId) {
              return;
            }
            if (event.target.checked) {
              manualSelectedQuestionIds.add(questionId);
            } else {
              manualSelectedQuestionIds.delete(questionId);
            }
            updateManualQuestionSummary();
          });
        });

        updateManualQuestionSummary();
      };

      const updateBlueprintDetail = () => {
        const selectedInput = blueprintSelectors().find((item) => item.checked && !item.closest('tr').classList.contains('d-none'));
        if (!selectedInput) {
          if (selectedBlueprintName) {
            selectedBlueprintName.textContent = 'Không có ma trận đề phù hợp';
          }
          if (blueprintInfoName) {
            blueprintInfoName.textContent = '-';
          }
          if (blueprintInfoUpdated) {
            blueprintInfoUpdated.textContent = '-';
          }
          if (blueprintInfoSubject) {
            blueprintInfoSubject.textContent = '-';
          }
          if (blueprintInfoQuestionCount) {
            blueprintInfoQuestionCount.textContent = '0 câu';
          }
          renderBlueprintMatrix([]);
          return;
        }

        const selectedRow = selectedInput.closest('tr');
        const blueprintId = selectedRow ? (selectedRow.getAttribute('data-blueprint-id') || '') : '';
        const detail = blueprintData[blueprintId];
        if (!detail) {
          renderBlueprintMatrix([]);
          return;
        }

        if (selectedBlueprintName) {
          selectedBlueprintName.textContent = `Đang chọn: ${detail.name}`;
        }
        if (blueprintInfoName) {
          blueprintInfoName.textContent = detail.name;
        }
        if (blueprintInfoUpdated) {
          blueprintInfoUpdated.textContent = detail.updated;
        }
        if (blueprintInfoSubject) {
          blueprintInfoSubject.textContent = detail.subject;
        }
        if (blueprintInfoQuestionCount) {
          blueprintInfoQuestionCount.textContent = `${detail.questionCount} câu`;
        }

        renderBlueprintMatrix(detail.matrix);
      };

      const getFilteredBlueprintRows = () => {
        const keyword = (blueprintSearchInput ? blueprintSearchInput.value : '').trim().toLowerCase();
        const selectedSubject = (blueprintSubjectFilter ? blueprintSubjectFilter.value : '').trim().toLowerCase();
        return blueprintRows().filter((row) => {
          const name = (row.getAttribute('data-blueprint-name') || '').toLowerCase();
          const subject = (row.getAttribute('data-subject') || '').toLowerCase();
          const matchName = keyword.length === 0 || name.includes(keyword);
          const matchSubject = selectedSubject.length === 0 || subject === selectedSubject;
          return matchName && matchSubject;
        });
      };

      const renderBlueprintList = (resetPage = false) => {
        if (!blueprintListTable) {
          return;
        }

        const filteredRows = getFilteredBlueprintRows();
        const totalRows = filteredRows.length;
        const totalPages = Math.max(1, Math.ceil(totalRows / blueprintPageSize));

        if (resetPage) {
          blueprintCurrentPage = 1;
        }
        blueprintCurrentPage = Math.min(blueprintCurrentPage, totalPages);

        const startIndex = totalRows === 0 ? 0 : (blueprintCurrentPage - 1) * blueprintPageSize;
        const endIndex = Math.min(startIndex + blueprintPageSize, totalRows);
        const visibleRows = filteredRows.slice(startIndex, endIndex);

        blueprintRows().forEach((row) => row.classList.add('d-none'));
        visibleRows.forEach((row) => row.classList.remove('d-none'));

        if (blueprintFilterSummary) {
          blueprintFilterSummary.textContent = totalRows === 0
            ? 'Không có ma trận đề phù hợp bộ lọc.'
            : `Hiển thị ${startIndex + 1}-${endIndex} trên ${totalRows} ma trận đề.`;
        }

        blueprintPageButtons.forEach((button, idx) => {
          const pageNumber = idx + 1;
          const pageItem = blueprintPageItems[idx];
          const isEnabled = totalRows > 0 && pageNumber <= totalPages;
          const isActive = isEnabled && blueprintCurrentPage === pageNumber;

          button.disabled = !isEnabled;

          if (pageItem) {
            pageItem.classList.toggle('active', isActive);
            pageItem.classList.toggle('disabled', !isEnabled);
          }
        });

        if (blueprintPaginationPrev) {
          blueprintPaginationPrev.disabled = totalRows === 0 || blueprintCurrentPage <= 1;
        }

        if (blueprintPaginationNext) {
          blueprintPaginationNext.disabled = totalRows === 0 || blueprintCurrentPage >= totalPages;
        }

        const selectedVisible = blueprintSelectors().some((item) => item.checked && !item.closest('tr').classList.contains('d-none'));
        if (!selectedVisible) {
          const firstVisibleRow = visibleRows[0];
          if (firstVisibleRow) {
            const firstInput = firstVisibleRow.querySelector('.blueprint-item');
            if (firstInput) {
              firstInput.checked = true;
            }
          }
        }

        updateBlueprintDetail();
      };

      classSelectors().forEach((item) => {
        item.addEventListener('change', updateSelectedCount);
      });

      classSearchInput.addEventListener('input', () => renderClassTable(true));
      if (classSubjectFilter) {
        classSubjectFilter.addEventListener('change', () => renderClassTable(true));
      }
      if (classSemesterFilter) {
        classSemesterFilter.addEventListener('change', () => renderClassTable(true));
      }
      if (classPaginationPrev) {
        classPaginationPrev.addEventListener('click', () => {
          if (currentPage > 1) {
            currentPage -= 1;
            renderClassTable();
          }
        });
      }
      if (classPaginationNext) {
        classPaginationNext.addEventListener('click', () => {
          currentPage += 1;
          renderClassTable();
        });
      }
      classPageButtons.forEach((button, idx) => {
        button.addEventListener('click', () => {
          currentPage = idx + 1;
          renderClassTable();
        });
      });
      blueprintSelectors().forEach((item) => {
        item.addEventListener('change', updateBlueprintDetail);
      });
      if (blueprintSearchInput) {
        blueprintSearchInput.addEventListener('input', () => renderBlueprintList(true));
      }
      if (blueprintSubjectFilter) {
        blueprintSubjectFilter.addEventListener('change', () => renderBlueprintList(true));
      }
      if (blueprintPaginationPrev) {
        blueprintPaginationPrev.addEventListener('click', () => {
          if (blueprintCurrentPage > 1) {
            blueprintCurrentPage -= 1;
            renderBlueprintList();
          }
        });
      }
      if (blueprintPaginationNext) {
        blueprintPaginationNext.addEventListener('click', () => {
          blueprintCurrentPage += 1;
          renderBlueprintList();
        });
      }
      blueprintPageButtons.forEach((button, idx) => {
        button.addEventListener('click', () => {
          blueprintCurrentPage = idx + 1;
          renderBlueprintList();
        });
      }
      publicToggle.addEventListener('change', applyPublicMode);
      publicToggle.addEventListener('input', applyPublicMode);
      if (examGenerationBlueprint) {
        examGenerationBlueprint.addEventListener('change', applyExamGenerationMode);
      }
      if (examGenerationManual) {
        examGenerationManual.addEventListener('change', applyExamGenerationMode);
      }
      if (manualQuestionSubjectFilter) {
        manualQuestionSubjectFilter.addEventListener('change', () => {
          syncManualQuestionChapterOptions();
          renderManualQuestionTable();
        });
      }
      if (manualQuestionChapterFilter) {
        manualQuestionChapterFilter.addEventListener('change', () => {
          renderManualQuestionTable();
        });
      }
      if (manualQuestionSearchInput) {
        manualQuestionSearchInput.addEventListener('input', () => {
          renderManualQuestionTable();
        });
      }
      if (manualQuestionClearButton) {
        manualQuestionClearButton.addEventListener('click', () => {
          manualSelectedQuestionIds.clear();
          renderManualQuestionTable();
          updateManualQuestionSummary();
        });
      }

      updateSelectedCount();
      applyPublicMode();
      applyExamGenerationMode();
      renderClassTable(true);
      renderBlueprintList(true);
      syncManualQuestionChapterOptions();
      renderManualQuestionTable();
      updateManualQuestionSummary();
    })();
  </script>
  <script>
    (() => {
      const publicToggle = document.getElementById('publicExamToggle');
      const publicSubjectSection = document.getElementById('publicSubjectSection');
      const publicSubjectFilter = document.getElementById('publicSubjectFilter');
      const blueprintSubjectFilter = document.getElementById('blueprintSubjectFilter');
      const manualQuestionSubjectFilter = document.getElementById('manualQuestionSubjectFilter');

      if (!publicToggle || !publicSubjectSection) {
        return;
      }

      const syncPublicSubjectVisibility = () => {
        const isPublic = Boolean(publicToggle.checked);
        publicSubjectSection.classList.toggle('d-none', !isPublic);
      };

      const syncPublicSubjectValue = () => {
        if (!publicToggle.checked) {
          if (blueprintSubjectFilter) {
            blueprintSubjectFilter.disabled = false;
          }
          if (manualQuestionSubjectFilter) {
            manualQuestionSubjectFilter.disabled = false;
          }
          return;
        }

        const selectedSubject = (publicSubjectFilter ? publicSubjectFilter.value : '').trim();
        if (blueprintSubjectFilter) {
          blueprintSubjectFilter.disabled = true;
          blueprintSubjectFilter.value = selectedSubject;
          blueprintSubjectFilter.dispatchEvent(new Event('change'));
        }
        if (manualQuestionSubjectFilter) {
          manualQuestionSubjectFilter.disabled = true;
          manualQuestionSubjectFilter.value = selectedSubject;
          manualQuestionSubjectFilter.dispatchEvent(new Event('change'));
        }
      };

      const syncAll = () => {
        syncPublicSubjectVisibility();
        syncPublicSubjectValue();
      };

      ['change', 'input', 'click'].forEach((eventName) => {
        publicToggle.addEventListener(eventName, syncAll);
      });
      if (publicSubjectFilter) {
        publicSubjectFilter.addEventListener('change', syncPublicSubjectValue);
      }

      syncAll();
    })();
  </script>
  <script>
    (() => {
      const blueprintModeRadio = document.getElementById('examGenerationBlueprint');
      const manualModeRadio = document.getElementById('examGenerationManual');
      const blueprintSection = document.getElementById('blueprintModeSection');
      const manualSection = document.getElementById('manualModeSection');

      if (!blueprintModeRadio || !manualModeRadio || !blueprintSection || !manualSection) {
        return;
      }

      const syncExamModeVisibility = () => {
        const manualMode = Boolean(manualModeRadio.checked);
        blueprintSection.hidden = manualMode;
        blueprintSection.style.display = manualMode ? 'none' : '';
        manualSection.hidden = !manualMode;
        manualSection.style.display = !manualMode ? 'none' : '';
      };

      ['change', 'input', 'click'].forEach((eventName) => {
        blueprintModeRadio.addEventListener(eventName, syncExamModeVisibility);
        manualModeRadio.addEventListener(eventName, syncExamModeVisibility);
      });

      syncExamModeVisibility();
    })();
  </script>
  <script>
    (() => {
      const saveTopBtn = document.getElementById('saveConfigTop');
      const saveBottomBtn = document.getElementById('saveConfigBottom');
      const closeTopBtn = document.getElementById('closeConfigTop');
      const closeBottomBtn = document.getElementById('closeConfigBottom');

      const triggerTopButtonClick = (button) => {
        if (button && typeof button.click === 'function') {
          button.click();
        }
      };

      if (saveBottomBtn) {
        saveBottomBtn.addEventListener('click', () => triggerTopButtonClick(saveTopBtn));
      }
      if (closeBottomBtn) {
        closeBottomBtn.addEventListener('click', () => triggerTopButtonClick(closeTopBtn));
      }
      if (saveTopBtn && !saveTopBtn.hasAttribute('data-mock-handler')) {
        saveTopBtn.setAttribute('data-mock-handler', 'true');
        saveTopBtn.addEventListener('click', () => {
          window.alert('Đã lưu cấu hình (mockup).');
        });
      }
      if (closeTopBtn && !closeTopBtn.hasAttribute('data-mock-handler')) {
        closeTopBtn.setAttribute('data-mock-handler', 'true');
        closeTopBtn.addEventListener('click', () => {
          window.alert('Đã đóng màn hình cấu hình (mockup).');
        });
      }
    })();
  </script>
  <script>
    (() => {
      const subjectEl = document.getElementById('manualQuestionSubjectFilter');
      const chapterEl = document.getElementById('manualQuestionChapterFilter');
      const levelEl = document.getElementById('manualQuestionLevelFilter');
      const searchEl = document.getElementById('manualQuestionSearchInput');
      const tableBody = document.getElementById('manualQuestionTableBody');
      const summaryEl = document.getElementById('manualQuestionSummary');
      const clearBtn = document.getElementById('manualQuestionClearButton');

      if (!subjectEl || !chapterEl || !tableBody || !summaryEl) {
        return;
      }

      const selectedIds = new Set();
      const questionBank = [
        {
          id: 'MAE-Q001',
          subject: 'MAE',
          chapter: 'Gioi han',
          level: 'Nhận biết',
          content: 'Tinh gioi han lim(x->0) (sin(3x) / x). Chon dap an dung.',
          tags: ['gioi han', 'limits', 'trac nghiem']
        },
        {
          id: 'MAE-Q002',
          subject: 'MAE',
          chapter: 'Gioi han',
          level: 'Thông hiểu',
          content: 'Tinh lim(x->2) (x^2 - 4) / (x - 2) va giai thich vi sao khong the thay truc tiep x = 2.',
          tags: ['gioi han', 'limits', 'tu luan ngan']
        },
        {
          id: 'MAE-Q003',
          subject: 'MAE',
          chapter: 'Gioi han',
          level: 'Vận dụng',
          content: 'Cho f(x) = (sqrt(x + 9) - 3) / x. Tinh lim(x->0) f(x).',
          tags: ['gioi han', 'limits', 'can bac hai']
        },
        {
          id: 'MAE-Q004',
          subject: 'MAE',
          chapter: 'Gioi han',
          level: 'Vận dụng cao',
          content: 'Tinh lim(x->+∞) (5x^2 - 2x + 1) / (x^2 + 3).',
          tags: ['gioi han', 'limits', 'vo cuc']
        },
        {
          id: 'MAE-Q010',
          subject: 'MAE',
          chapter: 'Dao ham',
          level: 'Nhận biết',
          content: 'Tinh dao ham cua ham so y = x^3 - 2x^2 + 5x - 1.',
          tags: ['dao ham', 'derivatives']
        },
        {
          id: 'MAE-Q011',
          subject: 'MAE',
          chapter: 'Dao ham',
          level: 'Thông hiểu',
          content: 'Viet phuong trinh tiep tuyen cua do thi y = x^2 + 1 tai diem co hoanh do x = 2.',
          tags: ['dao ham', 'derivatives', 'tiep tuyen']
        },
        {
          id: 'MAE-Q020',
          subject: 'MAE',
          chapter: 'Tich phan',
          level: 'Vận dụng',
          content: 'Tinh tich phan I = ∫(0->1) (2x + 1) dx.',
          tags: ['tich phan', 'integrals']
        },
        {
          id: 'MAD-Q003',
          subject: 'MAD',
          chapter: 'Data Types',
          level: 'Nhận biết',
          content: 'Trong C#, phat bieu nao dung khi so sanh value type va reference type?',
          tags: ['data types', 'csharp', 'trac nghiem']
        },
        {
          id: 'MAD-Q015',
          subject: 'MAD',
          chapter: 'OOP',
          level: 'Vận dụng',
          content: 'Cho doan code co ke thua va override. Hay xac dinh ket qua khi goi phuong thuc qua bien kieu lop cha.',
          tags: ['oop', 'inheritance', 'polymorphism']
        },
        {
          id: 'MAS-Q002',
          subject: 'MAS',
          chapter: 'Probability Basics',
          level: 'Thông hiểu',
          content: 'Hai bien co A va B doc lap, P(A)=0.4, P(B)=0.5. Tinh P(A ∩ B) va P(A ∪ B).',
          tags: ['probability', 'xac suat']
        }
      ];

      const normalize = (value = '') => value.toLowerCase().trim();

      const updateSummary = () => {
        summaryEl.textContent = `Da chon ${selectedIds.size} cau hoi thu cong.`;
      };

      const syncChapterOptions = () => {
        const selectedSubject = normalize(subjectEl.value || '');
        const chapters = Array.from(new Set(
          questionBank
            .filter((q) => selectedSubject.length === 0 || normalize(q.subject) === selectedSubject)
            .map((q) => q.chapter)
        ));

        const oldValue = chapterEl.value;
        chapterEl.innerHTML = '<option value="">Tat ca chuong</option>';
        chapters.forEach((chapter) => {
          const option = document.createElement('option');
          option.value = chapter;
          option.textContent = chapter;
          chapterEl.appendChild(option);
        });
        if (chapters.includes(oldValue)) {
          chapterEl.value = oldValue;
        }
      };

      const getFilteredQuestions = () => {
        const selectedSubject = normalize(subjectEl.value || '');
        const selectedChapter = normalize(chapterEl.value || '');
        const selectedLevel = normalize(levelEl ? levelEl.value || '' : '');
        const keyword = normalize(searchEl ? searchEl.value || '' : '');
        return questionBank.filter((q) => {
          const matchSubject = selectedSubject.length === 0 || normalize(q.subject) === selectedSubject;
          const chapterIndex = normalize(`${q.chapter} ${(q.tags || []).join(' ')}`);
          const matchChapter = selectedChapter.length === 0 || chapterIndex.includes(selectedChapter);
          const matchLevel = selectedLevel.length === 0 || normalize(q.level || '') === selectedLevel;
          const searchIndex = normalize(`${q.id} ${q.subject} ${q.chapter} ${q.content} ${(q.tags || []).join(' ')}`);
          const matchKeyword = keyword.length === 0 || searchIndex.includes(keyword);
          return matchSubject && matchChapter && matchLevel && matchKeyword;
        });
      };

      const renderRows = () => {
        const filtered = getFilteredQuestions();
        if (filtered.length === 0) {
          tableBody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Khong co cau hoi phu hop bo loc.</td></tr>';
          updateSummary();
          return;
        }

        tableBody.innerHTML = filtered.map((q) => `
          <tr>
            <td><input class="form-check-input manual-question-item" type="checkbox" data-question-id="${q.id}" ${selectedIds.has(q.id) ? 'checked' : ''}></td>
            <td>${q.id}</td>
            <td>${q.subject}</td>
            <td>${q.chapter}</td>
            <td>${q.level || '-'}</td>
            <td>${q.content}</td>
          </tr>
        `).join('');

        tableBody.querySelectorAll('.manual-question-item').forEach((checkbox) => {
          checkbox.addEventListener('change', () => {
            const id = checkbox.getAttribute('data-question-id');
            if (!id) {
              return;
            }
            if (checkbox.checked) {
              selectedIds.add(id);
            } else {
              selectedIds.delete(id);
            }
            updateSummary();
          });
        });

        updateSummary();
      };

      subjectEl.addEventListener('change', () => {
        syncChapterOptions();
        renderRows();
      });
      chapterEl.addEventListener('change', renderRows);
      if (levelEl) {
        levelEl.addEventListener('change', renderRows);
      }
      if (searchEl) {
        searchEl.addEventListener('input', renderRows);
      }
      if (clearBtn) {
        clearBtn.addEventListener('click', () => {
          selectedIds.clear();
          renderRows();
        });
      }

      syncChapterOptions();
      renderRows();
    })();
  </script>
  <script>
    (() => {
      const publicToggle = document.getElementById('publicExamToggle');
      const classSelectionBlock = document.getElementById('classSelectionBlock') || document.getElementById('classSelectionSection');

      if (!publicToggle || !classSelectionBlock) {
        return;
      }

      const syncPublicVisibility = () => {
        const shouldHide = Boolean(publicToggle.checked);
        classSelectionBlock.hidden = shouldHide;
        classSelectionBlock.style.display = shouldHide ? 'none' : '';
        classSelectionBlock.setAttribute('aria-hidden', shouldHide ? 'true' : 'false');
      };

      ['change', 'input', 'click'].forEach((eventName) => {
        publicToggle.addEventListener(eventName, syncPublicVisibility);
      });

      // Keep in sync when script/UI toggles checked state programmatically.
      const observer = new MutationObserver(syncPublicVisibility);
      observer.observe(publicToggle, { attributes: true, attributeFilter: ['checked'] });

      syncPublicVisibility();
    })();
  </script>
</body>
</html>
