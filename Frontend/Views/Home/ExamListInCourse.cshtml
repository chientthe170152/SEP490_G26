@model IEnumerable<Backend.DTOs.ExamInCourseDTO>?

@using System.Text.Json

@{
    // Determine role for conditional rendering.
    // Teacher sees (Details, Edit, Close).
    // Student sees (Take, Details).
    var isTeacher = User.IsInRole("Teacher");
    var isStudent = User.IsInRole("Student");
    if (isTeacher) isStudent = false; // prefer teacher when both roles exist

    // Chapters are passed from controller in ViewData["ChaptersJson"] as camelCase JSON.
    var chaptersJson = ViewData["ChaptersJson"] as string ?? "[]";
    var chapters = JsonSerializer.Deserialize<List<Backend.DTOs.ChapterDTO>>(chaptersJson, new JsonSerializerOptions
    {
        PropertyNameCaseInsensitive = true
    }) ?? new List<Backend.DTOs.ChapterDTO>();
}
<!doctype html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Danh sách đề trong lớp</title>
    <link rel="stylesheet" href="../vendor/bootstrap-5.3.8/css/bootstrap.min.css">
    <link rel="stylesheet" href="../css/exam_preview.css">
</head>
<body>
    <main class="page-shell py-4">
        <div class="container-fluid px-3 px-md-4">
            <section class="page-header d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-3">
                <div>
                    <h1 class="page-title">Danh sách đề trong lớp</h1>
                </div>
            </section>

            <section class="panel-card mb-3">
                <div class="row g-2">
                    <div class="col-12 col-lg-4">
                        <!-- Populate chapter options server-side to avoid client fetch/CORS issues -->
                        <select class="form-select" id="examChapterFilter">
                            <option value="">Tất cả chương</option>
                            @foreach (var ch in chapters)
                            {
                                <option value="@ch.ChapterId">@ch.Name</option>
                            }
                        </select>
                    </div>
                    <div class="col-6 col-lg-2">
                        <select class="form-select" id="examStatusFilter">
                            <option value="">Tất cả trạng thái</option>
                            <option value="1">Mở</option>
                            <option value="0">Đóng</option>
                            <option value="2">Sắp</option>
                        </select>
                    </div>
                    <div class="col-6 col-lg-4">
                        <input class="form-control" id="examSearchInput" placeholder="Search by exam name or code">
                    </div>
                </div>
            </section>

            <section class="panel-card">
                <div class="table-responsive">
                    <table class="table table-soft mb-0">
                        <thead>
                            <tr>
                                <th>Tên đề</th>
                                <th>Khoảng thời gian</th>
                                <th>Thời lượng</th>
                                <th>Trạng thái</th>
                                <th>Thao tác</th>
                            </tr>
                        </thead>
                        <tbody id="examTableBody">
                            @* Render exams from model. If none, show empty message. *@
                            @if (Model != null && Model.Any())
                            {
                                foreach (var e in Model)
                                {
                                    var keyword = $"{e.Title} {e.Code}".Trim().ToLowerInvariant();
                                    // Render chapter id into data attribute for client filtering
                                    <tr class="interactive-row" data-status="@e.Status" data-keyword="@keyword" data-chapter="@(e.ChapterId?.ToString() ?? "")">
                                        <td>@e.Title</td>
                                        <td>
                                            @* Prefer OpenAt - CloseAt if available; otherwise show VisibleFrom; else dash *@
                                            @{
                                                if (e.OpenAt.HasValue || e.CloseAt.HasValue)
                                                {
                                                    var open = e.OpenAt?.ToLocalTime().ToString("dd/MM/yyyy HH:mm") ?? "-";
                                                    var close = e.CloseAt?.ToLocalTime().ToString("dd/MM/yyyy HH:mm") ?? "-";
                                                    @($"{open} - {close}")
                                                }
                                                else
                                                {
                                                    @("-")
                                                }
                                            }
                                        </td>
                                        <td>@(e.DurationMinutes > 0 ? $"{e.DurationMinutes} phút" : "-")</td>
                                        <td>
                                            @* Map numeric status to badge and localized label. *@
                                            @if (e.Status == 1)
                                            {
                                                <span class="badge status-open" style="background:#eef2ff;color:#1d4ed8;">Mở</span>
                                            }
                                            else if (e.Status == 0)
                                            {
                                                <span class="badge status-closed" style="background:#eef2ff;color:red;">Đóng</span>
                                            }
                                            else
                                            {
                                                <span class="badge status-upcoming">Sắp</span>
                                            }
                                        </td>
                                        <td>
                                            <div class="toolbar d-flex gap-2">
                                                @if (isTeacher)
                                                {
                                                    @* Teacher: Details, Edit, Close (close is a POST) *@
                                                    <a class="btn btn-sm btn-outline-secondary" href="@Url.Action("Details", "Exam", new { id = e.ExamId })">Chi tiết</a>
                                                    <a class="btn btn-sm btn-primary" href="@Url.Action("Edit", "Exam", new { id = e.ExamId })">Sửa</a>
                                                    <form asp-controller="Exam" asp-action="Close" method="post" class="d-inline">
                                                        @Html.AntiForgeryToken()
                                                        <input type="hidden" name="examId" value="@e.ExamId" />
                                                        <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Bạn có chắc muốn đóng đề này?');">Đóng</button>
                                                    </form>
                                                }
                                                else if (isStudent)
                                                {
                                                    @* Student: Take (primary) and Details *@
                                                    <a class="btn btn-sm btn-primary" href="@Url.Action("Take", "Exam", new { id = e.ExamId })">Vào làm</a>
                                                    <a class="btn btn-sm btn-outline-secondary" href="@Url.Action("Details", "Exam", new { id = e.ExamId })">Chi tiết</a>
                                                }
                                                else
                                                {
                                                    @* Fallback for unauthenticated or other roles: show details only *@
                                                    <a class="btn btn-sm btn-outline-secondary" href="@Url.Action("Details", "Exam", new { id = e.ExamId })">Chi tiết</a>
                                                }
                                            </div>
                                        </td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="5" class="text-center text-muted">Hiện không có bài kiểm tra nào.</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </section>
        </div>
    </main>

    <script src="../vendor/bootstrap-5.3.8/js/bootstrap.bundle.min.js"></script>

    <script>
        (function () {
            // Filtering logic (status + keyword + chapter)
            const searchInput = document.getElementById('examSearchInput');
            const statusFilter = document.getElementById('examStatusFilter');
            const chapterFilter = document.getElementById('examChapterFilter');

            function rows() { return Array.from(document.querySelectorAll('#examTableBody tr.interactive-row')); }

            function applyFilters() {
                const keyword = (searchInput ? searchInput.value.trim().toLowerCase() : '');
                const status = (statusFilter ? statusFilter.value : '');
                const chapter = (chapterFilter ? chapterFilter.value : '');

                rows().forEach(r => {
                    const rowKeyword = (r.getAttribute('data-keyword') || '').toLowerCase();
                    const rowStatus = (r.getAttribute('data-status') || '');
                    const rowChapter = (r.getAttribute('data-chapter') || '');

                    const matchKeyword = keyword.length === 0 || rowKeyword.includes(keyword);
                    const matchStatus = status.length === 0 || rowStatus === status;
                    const matchChapter = chapter.length === 0 || rowChapter === chapter;

                    r.style.display = (matchKeyword && matchStatus && matchChapter) ? '' : 'none';
                });
            }

            if (searchInput) searchInput.addEventListener('input', applyFilters);
            if (statusFilter) statusFilter.addEventListener('change', applyFilters);
            if (chapterFilter) chapterFilter.addEventListener('change', applyFilters);

            // initial apply
            applyFilters();
        })();
    </script>

    <script src="../js/exam_preview.js"></script>
</body>
</html>