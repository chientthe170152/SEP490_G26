@model IEnumerable<Backend.DTOs.CourseDTO>?

@using System.Text.Json

@{
    // Role names use "Teacher" and "Student"
    var isTeacher = User.IsInRole("Teacher");
    var isStudent = User.IsInRole("Student");
    if (isTeacher) isStudent = false; // prefer teacher view when user has both roles

    var courses = Model ?? Enumerable.Empty<Backend.DTOs.CourseDTO>();
    // gather distinct semesters from data (non-empty)
    var semesters = courses.Select(c => c.Semester).Where(s => !string.IsNullOrEmpty(s)).Distinct();
}
<!doctype html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@(isTeacher ? "Danh sách khóa học giảng dạy" : "Danh sách khóa học của tôi")</title>
    <link rel="stylesheet" href="~/vendor/bootstrap-5.3.8/css/bootstrap.min.css">
    <link rel="stylesheet" href="~/css/exam_preview.css">
    <style>
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill,minmax(280px,1fr));
            gap: 16px;
        }

        .class-card {
            background: #fff;
            border: 1px solid #e9ecef;
            padding: 16px;
            border-radius: 8px;
        }

        .tag-pill {
            padding: .25rem .5rem;
            border-radius: 999px;
            font-weight: 600;
            display: inline-block;
        }

        .status-open {
            background: #eef2ff;
            color: #1d4ed8;
        }

        .status-closed {
            background: #fff1f0;
            color: #c2410c;
        }

        .card-meta {
            color: #6b7280;
            margin-top: 6px;
        }

        .card-actions {
            margin-top: 12px;
            display: flex;
            gap: 8px;
        }
    </style>
</head>
<body>
    <main class="page-shell py-4">
        <div class="container-fluid px-3 px-md-4">
            <section class="page-header d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-3 mb-3">
                <div>
                    <h1 class="page-title">@((isTeacher) ? "Danh sách lớp giảng dạy" : "Lớp học của tôi")</h1>
                    <p class="page-subtitle">
                        @if (isTeacher)
                        {
                            @:Tìm kiếm và quản lý các lớp học bạn đang giảng dạy.
                        }
                        else
                        {
                            @:Tìm kiếm và truy cập các lớp đã tham gia.
                        }
                    </p>
                </div>
                <div class="page-actions">
                    @if (isTeacher)
                    {
                        <a class="btn btn-primary" href="@Url.Action("Create", "Class")">Tạo lớp</a>
                    }
                    else
                    {
                        <button class="btn btn-primary" type="button" data-bs-toggle="modal" data-bs-target="#joinClassModal">Tham gia lớp</button>
                    }
                </div>
            </section>

            <section class="panel-card mb-3">
                <div class="row g-2">
                    <div class="col-12 col-lg-4">
                        <input type="text" class="form-control" id="courseSearchInput" placeholder="Tìm theo mã lớp, tên giảng viện hoặc từ khóa">
                    </div>
                    <div class="col-6 col-lg-3">
                        <select class="form-select" id="courseSemesterFilter">
                            <option value="">Tất cả học kỳ</option>
                            @* dynamic semesters from database *@
                            @foreach (var sem in semesters)
                            {
                                <option value="@sem">@sem</option>
                            }
                        </select>
                    </div>

                    <div class="col-6 col-lg-3">
                        <select class="form-select" id="courseSubjectFilter">
                            <option value="">Tất cả môn học</option>
                            @* Use SubjectName for filtering; values will be matched case-insensitive in JS *@
                            @foreach (var subj in courses.Select(c => c.SubjectName).Where(n => !string.IsNullOrEmpty(n)).Distinct())
                            {
                                <option value="@subj">@subj</option>
                            }
                        </select>
                    </div>

                    <div class="col-12 col-lg-2 d-grid">
                        <button class="btn btn-outline-secondary" id="showClosedCoursesBtn" type="button">
                            Hiển thị khóa học
                        </button>
                    </div>
                </div>
            </section>

            <!-- Cards -->
            <section class="card-grid" id="courseGrid">
                @foreach (var c in courses)
                {
                    // Build a simple keyword string for client filters
                    var keyword = $"{c.ClassName} {c.TeacherName} {c.SubjectName}".Trim();
                    // semester and status come from CourseDTO/DB
                    <article class="class-card" data-course-card
                             data-subject="@(c.SubjectName ?? "")"
                             data-semester="@(c.Semester ?? "")"
                             data-status="open"
                             data-keyword="@keyword.ToLowerInvariant()">
                        <h2 class="card-title">@c.ClassName</h2>
                        <p class="card-subtitle">@c.TeacherName</p>
                        <div class="mt-1"><small class="text-muted">Học kỳ: @c.Semester</small></div>
                        <div class="card-meta">
                            <span>
                                @if (isTeacher)
                                {
                                    @:Sĩ số: @c.StudentCount &nbsp;•&nbsp; Exams: @c.ExamCount
                                }
                                else
                                {
                                    @:Exams: @c.ExamCount &nbsp;•&nbsp; Sĩ số: @c.StudentCount
                                }
                            </span>
                            
                        </div>
                        <div class="tag-list mt-2">
                            <span class="tag-pill status-open">Open</span>
                        </div>
                        <div class="card-actions">
                            <a class="btn btn-sm @(isTeacher ? "btn-primary" : "btn-outline-primary")"
                               href="@Url.Action("ExamList", "Course", new { id = c.ClassId })">Vào khóa học</a>

                            @if (!isTeacher)
                            {
                                <form method="post" asp-controller="Class" asp-action="Leave" class="d-inline">
                                    <input type="hidden" name="classId" value="@c.ClassId" />
                                    <button type="submit" class="btn btn-sm btn-outline-danger">Rời khóa học</button>
                                </form>
                            }
                            else
                            {
                                <a class="btn btn-sm btn-light border" href="@Url.Action("Manage", "Class", new { id = c.ClassId })">Quản lý</a>
                            }
                        </div>
                    </article>
                }
            </section>

            <nav class="mt-3" aria-label="Phân trang lớp học">
                <ul class="pagination mb-0">
                    <li class="page-item disabled"><span class="page-link">Trước</span></li>
                    <li class="page-item active"><span class="page-link">1</span></li>
                    <li class="page-item"><a class="page-link" href="#">2</a></li>
                    <li class="page-item"><a class="page-link" href="#">Sau</a></li>
                </ul>
            </nav>
        </div>
    </main>

    @if (!isTeacher)
    {
        <div class="modal fade" id="joinClassModal" tabindex="-1" aria-labelledby="joinClassModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <form class="modal-content" id="joinClassForm" method="post" asp-controller="Class" asp-action="Join">
                    <div class="modal-header">
                        <h2 class="modal-title fs-5" id="joinClassModalLabel">Nhập mã mời vào lớp</h2>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
                    </div>
                    <div class="modal-body">
                        <label class="form-label" for="joinClassCodeInput">Mã mời *</label>
                        <input class="form-control" id="joinClassCodeInput" name="inviteCode" placeholder="Nhập mã mời (ví dụ: INV-SE1711)" autocomplete="off" required>
                        <p class="form-note mt-2 mb-0">Nhập mã mời do giảng viên cung cấp để tham gia lớp học.</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Hủy</button>
                        <button type="submit" class="btn btn-primary">Xác nhận tham gia</button>
                    </div>
                </form>
            </div>
        </div>
    }

    <script src="~/vendor/bootstrap-5.3.8/js/bootstrap.bundle.min.js"></script>
    <script>
        (function () {
            const searchInput = document.getElementById('courseSearchInput');
            const semesterFilter = document.getElementById('courseSemesterFilter');
            const subjectFilter = document.getElementById('courseSubjectFilter');
            const showClosedBtn = document.getElementById('showClosedCoursesBtn');
            const courseCards = Array.from(document.querySelectorAll('[data-course-card]'));
            let showClosed = false;

            function applyFilters() {
                const keyword = (searchInput ? searchInput.value : '').trim().toLowerCase();
                const semester = (semesterFilter ? semesterFilter.value : '').trim().toLowerCase();
                const subject = (subjectFilter ? subjectFilter.value : '').trim().toLowerCase();

                courseCards.forEach((card) => {
                    const cardSubject = (card.getAttribute('data-subject') || '').toLowerCase();
                    const cardSemester = (card.getAttribute('data-semester') || '').toLowerCase();
                    const cardStatus = (card.getAttribute('data-status') || '').toLowerCase();
                    const cardKeyword = (card.getAttribute('data-keyword') || '').toLowerCase();

                    const matchKeyword = keyword.length === 0 || cardKeyword.includes(keyword);
                    const matchSemester = semester.length === 0 || cardSemester === semester;
                    const matchSubject = subject.length === 0 || cardSubject === subject;
                    const matchStatus = showClosed || cardStatus !== 'closed';

                    card.classList.toggle('d-none', !(matchKeyword && matchSemester && matchSubject && matchStatus));
                });
            }

            if (searchInput) searchInput.addEventListener('input', applyFilters);
            if (semesterFilter) semesterFilter.addEventListener('change', applyFilters);
            if (subjectFilter) subjectFilter.addEventListener('change', applyFilters);
            if (showClosedBtn) {
                showClosedBtn.addEventListener('click', function () {
                    showClosed = !showClosed;
                    showClosedBtn.textContent = showClosed ? 'Ẩn khóa học' : 'Hiển thị khóa học';
                    showClosedBtn.classList.toggle('btn-primary', showClosed);
                    showClosedBtn.classList.toggle('btn-outline-secondary', !showClosed);
                    applyFilters();
                });
            }

            applyFilters();
        })();
    </script>
</body>
</html>